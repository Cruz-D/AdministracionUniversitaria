@model AdministracionUniversitaria.ViewModels.MatriculaViewModel

@{
    ViewBag.Title = "MatriculacionesPage";
}

<h2>Matricular</h2>

@using (Html.BeginForm("Matricular", "Matriculacion", FormMethod.Post))
{
    <div class="form-group mt-3">
        @Html.LabelFor(x => x.Alumnos)
        @*//dropdownlistfor que pinta un dropdownlist con los alumnos que se le pasan en el modelo*@
        @Html.DropDownListFor(x => x.IdAlumno,
                  Model.Alumnos, "Seleccione un alumno",
                  new { @class = "form-control" })
    </div>

    <div class="form-group mt-3">
        @Html.LabelFor(x => x.Carreras)
        @*//dropdownlistfor que pinta un dropdownlist con los las carreras y lo controlamos plantandole un id*@
        @Html.DropDownListFor(x => x.IdCarrera,
                 Model.Carreras, "Seleccione una Carrera",
                 new { @class = "form-control", @id = "ddlCarreras" })
    </div>

    <div class="form-group mt-3">
        @Html.LabelFor(x => x.Asignaturas)
        @*//dropdownlistfor que pinta un dropdownlist con las asignaturas y lo controlamos plantandole un id*@
        @Html.DropDownListFor(x => x.IdAsignaruta, new List<SelectListItem>(),
        "Seleccione una asignatura", new { @class = "form-control", @id = "ddlAsignatura" })
    </div>

    <div class="form-group mt-3">

        <button type="submit" class="btn btn-primary">Matricular</button>

    </div>
}

<div class="container mt-5">

    <div class="text-center bg-black">
        <h3 class="text-bg-light">Matriculaciones</h3>
    </div>

    <table class="table table-striped table-bordered">
        <thead class="thead-dark">
            <tr>
                <th>Acciones</th>
                <th>Alumno</th>
                <th>Asignatura</th>
                <th>Fecha de Matriculacion</th>
                
            </tr>
        </thead>
        <tbody>
            @foreach (var matricula in Model.Matriculas)
            {
                <tr>
                    <td>
                        <table>
                            <tr>
                                <td>
                                    @using (Html.BeginForm("EditMatricula", "Matriculacion", new { IdMatricula = matricula.IdMatricula }, FormMethod.Post))
                                    {
                                        <button type="submit" class="btn btn-primary">Editar</button>
                                    }
                                </td>
                                <td>
                                    @using (Html.BeginForm("DeleteMatricula", "Matriculacion", new { IdMatricula = matricula.IdMatricula }, FormMethod.Post))
                                    {
                                        <button type="submit" class="btn btn-danger">Borrar</button>
                                    }
                                </td>
                            </tr>
                        </table>
                    </td>

                    <td>@matricula.Alumno</td>
                    <td>@matricula.Asignatura</td>
                    <td>@matricula.FechaMatricula.ToString("dd/MM/yyyy")</td>
                </tr>
            }
        </tbody>
    </table>

</div>

@section scripts{
    <script>
        // cargar asignaturas al cambiar de carrera en el dropdownlist

        // cuando cambie el dropdownlist de carreras usando change
        $("#ddlCarreras").change(function () {
            // alamacenamos el id de la carrera seleccionada
            var idCarrera = $(this).val();
            // llamamos a la accion de obtener asignaturas
            console.log("ID CARRERA ---------> " + idCarrera);
            // pasandole el id de la carrera seleccionada usando ajax
            $.ajax({
                // url de la accion
                url: '@Url.Action("GetAsignaturas", "Matriculacion")',
                // tipo de peticion
                type: 'GET',
                // datos que le pasamos a la accion
                data: { idCarrera: idCarrera },
                // tipo de datos que esperamos recibir
                dataType: 'json',
                // si es correcta la peticion
                success: function (data) {
                    console.log("SUCCESS ------>");
                    console.log(data);
                    // almacenamos el dropdownlist de asignaturas
                    var ddlAsignatura = $('#ddlAsignatura');
                    // borramos el dropdownlist de asignaturas
                    ddlAsignatura.empty();
                    // añadimos un option al dropdownlist de asignaturas
                    ddlAsignatura.append('<option value ="">Seleccione una Asignatura</asignatura>');
                    // con un bucle recorremos los datos que nos ha devuelto la accion
                    $.each(data, function (index, row) {
                        // añadimos un option al dropdownlist de asignaturas
                        ddlAsignatura.append('<option value="' + row.Value + '">' + row.Text + '</option>');

                        console.log("ID ASIGNATURA ---------> " + row.Value);
                    });

                },
                error: function (xhr, status, error) {
                    console.error('Error al cargar las asignaturas: ' + error);
                }
            });

        });



    </script>
}
